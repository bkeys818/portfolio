# This is a basic workflow to help you get started with Actions

name: Compile Website

on:
  push:
    branches: [ rebuild-worflow ]
  workflow_dispatch:


env:
  PUB_BRANCH: publish


jobs:

  find-files:
    runs-on: ubuntu-latest
    outputs:
      sass_sources: ${{ steps.find-files.outputs.sass_sources }}
      sass_destinations: ${{ steps.find-files.outputs.sass_destinations }}
      ts_files: ${{ steps.find-files.outputs.ts_files }}
      js_files: ${{ steps.find-files.outputs.js_files }}
      html_files: ${{ steps.find-files.outputs.html_files }}
      svg_files: ${{ steps.find-files.outputs.svg_files }}
    env:
      ignore: |
        ./.github
    steps:
      - uses: actions/checkout@v2

      - name: Find files
        id: find-files
        run: ./.github/scripts/find-files.sh

      - name: Create new branch
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git branch -f $PUB_BRANCH

      - name: Upload Sass files
        if: ${{ steps.find-files.outputs.sass_sources != '' }}
        uses: actions/upload-artifact@v2
        with:
          name: sass-files
          retention-days: 1
          path: |
            **/*.sass
            **/*.scss
        
      - name: Upload Typescript files
        if: ${{ steps.find-files.outputs.ts_files != '' }}
        uses: actions/upload-artifact@v2
        with:
          name: ts-files
          retention-days: 1
          path: '**/*.ts'

      - name: Upload Javascript files
        if: ${{ steps.find-files.outputs.js_files != '' }}
        uses: actions/upload-artifact@v2
        with:
          name: js-files
          retention-days: 1
          path: '**/*.js'

      - name: Upload HTML files
        if: ${{ steps.find-files.outputs.html_files != '' }}
        uses: actions/upload-artifact@v2
        with:
          name: html-files
          retention-days: 1
          path: '**/*.html'

      - name: Upload SVG files
        if: ${{ steps.find-files.outputs.svg_files != '' }}
        uses: actions/upload-artifact@v2
        with:
          name: svg-files
          retention-days: 1
          path: '**/*.svg'


  compile-sass:
    runs-on: ubuntu-latest
    needs: find-files
    if: ${{ needs.find-files.outputs.sass_sources != '' }}
    steps:
      - name: Download artifact w/ Sass files
        uses: actions/download-artifact@v2
        with:
          name: sass-files

      - name: Compile Sass 
        uses: bkeys818/sass-build@master
        with:
          source: |
            ${{needs.find-files.outputs.sass_sources}}
          destination: |
            ${{needs.find-files.outputs.sass_destinations}}

      - name: Upload Compiled files
        uses: actions/upload-artifact@v2
        with:
          name: complete
          retention-days: 1
          path: '**/*.css'


  compile-ts:
    runs-on: ubuntu-latest
    needs: find-files
    if: ${{ needs.find-files.outputs.ts_files != '' }}
    steps:
      - name: Download artifact w/ Typescript files
        uses: actions/download-artifact@v2
        with:
          name: ts-files
      
      - name: Compile TypeScript
        run: |
          while IFS= read -r file; do
            echo "$file"
            tsc "$file"
          done <<< "${{needs.find-files.outputs.ts_files}}"

      - name: Upload Compiled files
        uses: actions/upload-artifact@v2
        with:
          name: complete
          retention-days: 1
          path: '**/*.js'

  make-changes:
    runs-on: ubuntu-latest
    if: always()
    needs: [compile-sass, compile-ts]
    steps:
      - name: Download artifact w/ compiled and minified files
        uses: actions/download-artifact@v2
        with:
          name: complete
      
      - run: ls -1R

      - name: Delete Artifact by Name
        uses: jimschubert/delete-artifacts-action@v1
        with:
          pattern: 'sass-files|ts-files|js-files|html-files|svg-files|complete'
          log_level: 'info'
          min_bytes: '0'